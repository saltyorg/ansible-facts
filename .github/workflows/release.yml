name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - '*'

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux x86_64 (MUSL - static binary)
          - target: x86_64-unknown-linux-musl
            arch: amd64

          # Linux ARM64 (MUSL - static binary)
          - target: aarch64-unknown-linux-musl
            arch: arm64

          # Linux ARM v7 (MUSL - static binary)
          - target: armv7-unknown-linux-musleabihf
            arch: armv7

          # Linux ARM v6 (MUSL - static binary)
          - target: arm-unknown-linux-musleabihf
            arch: armv6

          # Linux ARM v5 (MUSL - static binary)
          - target: arm-unknown-linux-musleabi
            arch: armv5

    steps:
      - uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build Release Binary
        run: cross build --release --target ${{ matrix.target }}

      - name: Prepare binary
        run: |
          cd target/${{ matrix.target }}/release
          BINARY_NAME="saltbox-facts"
          OUTPUT_NAME="saltbox-facts-${{ matrix.arch }}"
          mv ${BINARY_NAME} ${OUTPUT_NAME}

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: saltbox-facts-${{ matrix.arch }}
          path: target/${{ matrix.target }}/release/saltbox-facts-${{ matrix.arch }}

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts
          pattern: saltbox-facts-*
          merge-multiple: false

      - name: Prepare release files
        run: |
          mkdir -p release
          # Move all binaries to release directory
          for dir in artifacts/saltbox-facts-*; do
            if [ -d "$dir" ]; then
              mv "$dir"/* release/
            fi
          done
          
          # Create legacy name for amd64 if it exists
          if [ -f "release/saltbox-facts-amd64" ]; then
            cp release/saltbox-facts-amd64 release/saltbox-facts
            echo "Created legacy binary: saltbox-facts"
          fi
          
          # List files for verification
          echo "Release files:"
          ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
